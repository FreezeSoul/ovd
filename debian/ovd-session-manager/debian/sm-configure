#!/bin/sh


pass=$(</dev/urandom tr -dc A-Za-z0-9 | head -c 8 )
echo "mysql-server-5.0 mysql-server/root_password_again password $pass" | debconf-set-selections
echo "mysql-server-5.0 mysql-server/root_password password $pass" | debconf-set-selections
echo "$pass" > /etc/ulteo-ovd-session-manager.secret
chmod 600 /etc/ulteo-ovd-session-manager.secret
dbserver=localhost
dbname=ulteo_sm
dbuser=ulteoadmin

echo "ulteo-ovd-session-manager-demo ulteo-ovd-session-manager/oem boolean true" | debconf-set-selections
echo "ulteo-ovd-session-manager-demo ulteo-ovd-session-manager/mysql_dbuser string $dbuser" | debconf-set-selections
echo "ulteo-ovd-session-manager-demo ulteo-ovd-session-manager/mysql_dbname string $dbname" | debconf-set-selections
echo "ulteo-ovd-session-manager-demo ulteo-ovd-session-manager/mysql_dbserver string $dbserver" | debconf-set-selections
echo "ulteo-ovd-session-manager ulteo-ovd-session-manager/admin_password_again password admin" | debconf-set-selections
echo "ulteo-ovd-session-manager ulteo-ovd-session-manager/admin_password password admin" | debconf-set-selections
echo "ulteo-ovd-session-manager-demo ulteo-ovd-session-manager/mysql_dbadmpass password $pass" | debconf-set-selections
echo "ulteo-ovd-session-manager-demo ulteo-ovd-session-manager/mysql_dbpass password $pass" | debconf-set-selections
echo "ulteo-ovd-session-manager ulteo-ovd-session-manager/password_mismatch boolean false" | debconf-set-selections
echo "ulteo-ovd-session-manager-demo ulteo-ovd-session-manager/mysql_configure boolean true" | debconf-set-selections



dpkg-reconfigure -fnoninteractive mysql-server-5.0
dpkg-reconfigure -fnoninteractive ulteo-ovd-session-manager
dpkg-reconfigure -fnoninteractive ulteo-ovd-session-manager-demo
rm -f /etc/rc2.d/S98sessionmanager_first

/usr/bin/env php /usr/share/ulteo/sessionmanager/admin/init/setup.php \
			$dbserver \
			$dbname \
			ulteo_ \
			$dbuser \
			$pass

chown -R www-data:www-data /var/spool/ulteo/sessionmanager /var/log/ulteo/sessionmanager
chmod 2770 /var/spool/ulteo/sessionmanager /var/log/ulteo/sessionmanager

<?xml version="1.0"?>

<project name="ulteo" default="applet">
  <property name="build.cert" value="/usr/share/ulteo/ovd-cert/"/>
  <property name="keystore.password" value="123456"/>

  <property name="compile.debug" value="false"/>
  <property name="compile.deprecation" value="false"/>
  <property name="compile.optimize" value="true"/>
  <property name="compile.version" value="1.5"/>
  <property name="compile.release" value="0.5.0"/>

  <property name="rdesktop.dist"  value="rdesktop" />
  <property name="integrated.dist"  value="integrated" />
  <property name="ovdClient.dist"  value="OvdClient" />
  <property name="PDFPrinter.dist"  value="PDFPrinter" />
  <property name="standalone.dist"  value="standalone" />
  <property name="rdpClient.dist"  value="rdpClient" />
  <property name="vdi.dist"  value="vdi" />

  <property name="prefix"      location="/usr/local" />
  <property name="datadir"     location="${prefix}/share" />
  <property name="destdir"     location="" />

  <property name="version" value="@VERSION@" />

  <property name="tar.dir" value="ovd-applets-${version}" />
  <property name="tar"     value="${tar.dir}.tar" />
  <property name="tar.gz"  value="${tar}.gz" />

  <target name="precompile">
    <mkdir dir="classes"/>
    <mkdir dir="jar"/>
    <mkdir dir="jar/ressources"/>
    <mkdir dir="jar/ressources/keymaps"/>
    <copy todir="jar/ressources/keymaps">
      <fileset dir="keymaps"/>
    </copy>

    <mkdir dir="libs"/>
  </target>

 <target name="precompile_printing">
   <mkdir dir="classes"/>
   <mkdir dir="jar"/>
   <mkdir dir="jar/org"/>
   <mkdir dir="jar/org/jpedal"/>
   <mkdir dir="jar/org/jpedal/res"/>
   <copy todir="jar/org/jpedal/res">
     <fileset dir="src/org/jpedal/res"/>
   </copy>
     <mkdir dir="libs"/>
   </target>

  <target name="classes2jar" description="copy classes/** to jar/">
    <copy todir="jar/">
      <fileset dir="classes">
	<include name="**/**"/>
      </fileset>
    </copy>
  </target>

 <target name="classes2jarPrinter" description="copy classes/** to jar/">
   <copy todir="jar/">
     <fileset dir="classes">
       <include name="**/**"/>
     </fileset>
   </copy>
 </target>
  <!-- Rdesktop part -->
  <target name="rdesktop.clean" depends="clean">
    <delete dir="${rdesktop.dist}"/>
  </target>

  <target name="rdesktop" depends="rdesktop.clean,precompile" description="compile the Java source code to class files">
    <javac srcdir="./src;./src1.4"
           destdir="classes"
           encoding="UTF8"
           target="1.5"
           source="1.5"
           classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar;"
           includes="net/propero/rdp/Rdesktop.java"/>
  </target>

  <target name="rdesktop.jar" depends="rdesktop,classes2jar" description="create jar file">
    <jar destfile="libs/rdesktop.jar" basedir="jar/">
      <include name="**"/>
      <manifest>
        <attribute name="Main-Class" value="net.propero.rdp.Rdesktop"/>
        <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="rdesktop.install" depends="rdesktop.jar">
    <mkdir dir="${rdesktop.dist}"/>

    <copy todir="${rdesktop.dist}">
      <fileset dir="./libs">
        <include name="rdesktop.jar" />
      </fileset>
      <fileset dir="./required_libraries">
        <include name="gnu-getopt.jar" />
        <include name="log4j-1.2.jar" />
      </fileset>
    </copy>
  </target>


  <!-- RDP Client part -->

  <target name="rdpClient.clean" depends="clean">
    <delete dir="${rdpClient.dist}"/>
  </target>

  <target name="rdpClient" depends="rdpClient.clean,precompile">
    <javac srcdir="./src;./src1.4"
           destdir="classes"
           encoding="UTF8"
           target="1.5"
           source="1.5"
           classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar;"
           includes="org/ulteo/rdp/RdpClient.java"/>
  </target>

  <target name="rdpClient.jar" depends="rdpClient,classes2jar">
    <jar destfile="libs/RDPClient.jar" basedir="jar/">
      <include name="**"/>

      <manifest>
        <attribute name="Main-Class" value="org.ulteo.rdp.RdpClient"/>
        <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="rdpClient.install" depends="rdpClient.jar">
    <mkdir dir="${rdpClient.dist}"/>

    <copy todir="${rdpClient.dist}">
      <fileset dir="./libs">
        <include name="RDPClient.jar" />
      </fileset>
      <fileset dir="./required_libraries">
        <include name="gnu-getopt.jar" />
        <include name="log4j-1.2.jar" />
      </fileset>
    </copy>
  </target>

  <!-- PDFPrinter part -->

 <target name="PDFPrinter.clean" >
   <delete dir="${PDFPrinter.dist}"/>
   <delete dir="classes"/>
   <delete dir="libs"/>
   <delete dir="jar"/>
 </target>

 <target name="PDFPrinter" depends="PDFPrinter.clean,precompile_printing" description="compile the Java source code to class files">
   <javac srcdir="./src"
          destdir="classes"
          encoding="UTF8"
          target="1.5"
          source="1.5"
          classpath="required_libraries/jai_codec.jar;required_libraries/jai_core.jar;required_libraries/js.jar;"
          includes="org/ulteo/ovd/printer/PrinterApplet.java"/>
 </target>
 <target name="PDFPrinter.jar" depends="PDFPrinter,classes2jarPrinter" description="create jar file">
   <jar destfile="libs/PDFPrinter.jar" basedir="jar/">
     <include name="**"/>
     <manifest>
       <attribute name="Main-Class" value="org.ulteo.ovd.printer.PrinterApplet"/>
     </manifest>
   </jar>
   <signjar jar="libs/PDFPrinter.jar"
            alias="ulteo"
            storepass="${keystore.password}"
            keystore="${build.cert}/keystore"
            signedjar="libs/PDFPrinter-${compile.release}.jar"/>
 </target>

 <target name="PDFPrinter.install"
         description="install applets"
         depends="PDFPrinter.jar">
   <mkdir dir="${destdir}${datadir}/ulteo/applets"/>
   <copy todir="${destdir}${datadir}/ulteo/applets">
     <fileset dir="./libs">
       <include name="PDFPrinter-${compile.release}.jar" />
     </fileset>
   </copy>
   <symlink link="${destdir}${datadir}/ulteo/applets/PDFPrinter.jar"
            resource="PDFPrinter-${compile.release}.jar"/>
 </target>

  <!-- Integrated client part -->

  <target name="integrated.clean" depends="clean">
    <delete dir="${integrated.dist}"/>
  </target>

  <target name="integrated" depends="integrated.clean,precompile">
    <javac srcdir="./src;./src1.4"
           destdir="classes"
           encoding="UTF8"
           target="1.5"
           source="1.5"
           classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar;required_libraries/jshortcut.jar;required_libraries/image4j.jar;required_libraries/registry.jar;required_libraries/jai_codec.jar;required_libraries/jai_core.jar;required_libraries/js.jar;"
           includes="org/ulteo/ovd/integrated/Client.java"/>
  </target>

  <target name="integrated.jar" depends="integrated,classes2jar">
    <jar destfile="libs/UlteoOVDIntegratedClient.jar" basedir="jar/">
      <include name="**"/>

      <manifest>
        <attribute name="Main-Class" value="org.ulteo.ovd.integrated.Client"/>
        <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar jshortcut.jar image4j.jar registry.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="integrated.install" depends="integrated.jar">
    <mkdir dir="${integrated.dist}"/>

    <copy todir="${integrated.dist}">
      <fileset dir="./libs">
        <include name="UlteoOVDIntegratedClient.jar" />
      </fileset>
      <fileset dir="./required_libraries">
        <include name="gnu-getopt.jar" />
        <include name="log4j-1.2.jar" />
      </fileset>
    </copy>
  </target>


  <!-- Ovd client part -->
  
  <target name="ovdClient.clean" depends="clean">
    <delete dir="${ovdClient.dist}"/>
  </target>

  <target name="ovdClient" depends="ovdClient.clean,precompile">
    <javac srcdir="./src;./src1.4"
           destdir="classes"
           encoding="UTF8"
           target="1.5"
           source="1.5"
           classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar;required_libraries/swingx.jar;required_libraries/registry.jar;required_libraries/jshortcut.jar;required_libraries/image4j.jar;required_libraries/jai_codec.jar;required_libraries/jai_core.jar;required_libraries/js.jar;"
           includes="org/ulteo/ovd/client/StartConnection.java"/>
  </target>

  <target name="ovdClient.jar" depends="ovdClient,classes2jar">
    <mkdir dir="external_jars"/>
    <mkdir dir="external_jars/swingx"/>
    <mkdir dir="external_jars/gnu-getopt"/>
    <mkdir dir="external_jars/log4j-1.2"/>
    <mkdir dir="external_jars/registry"/>
    <mkdir dir="external_jars/jshortcut"/>
    <mkdir dir="external_jars/image4j"/>
    <mkdir dir="ressources"/>

    <unjar src="required_libraries/gnu-getopt.jar" dest="external_jars/gnu-getopt"/>
    <unjar src="required_libraries/log4j-1.2.jar" dest="external_jars/log4j-1.2"/>
    <unjar src="required_libraries/swingx.jar" dest="external_jars/swingx"/>
    <unjar src="required_libraries/registry.jar" dest="external_jars/registry"/>
    <unjar src="required_libraries/jshortcut.jar" dest="external_jars/jshortcut"/>
    <unjar src="required_libraries/image4j.jar" dest="external_jars/image4j"/>

    <!-- Auto-generated exec ant command for i18n fonctionality -->
    @MESSAGE_LANGS@

    <copy todir="jar/">
      <fileset dir="ressources">
        <include name="*" />
      </fileset>
    </copy>

    <copy todir="jar/gnu">
      <fileset dir="external_jars/gnu-getopt/gnu">
	<include name="**/**"/>
      </fileset>
    </copy>

    <copy todir="jar/org">
      <fileset dir="external_jars/swingx/org">
	<include name="**/**"/>
      </fileset>
    </copy>
    
    <copy todir="jar/org">
      <fileset dir="external_jars/log4j-1.2/org">
	<include name="**/**"/>
      </fileset>
    </copy>
    
    <copy todir="jar/com">
      <fileset dir="external_jars/registry/com">
	<include name="**/**"/>
      </fileset>
    </copy>

    <copy todir="jar/net">
      <fileset dir="external_jars/image4j/net">
	<include name="**/**"/>
      </fileset>
    </copy>

    <copy todir="jar/net">
      <fileset dir="external_jars/jshortcut/net">
	<include name="**/**"/>
      </fileset>
    </copy>

    <copy todir="jar/pics">
      <fileset dir="icons">
	<include name="*"/>
      </fileset>
    </copy>


    <jar destfile="libs/UlteoOVDClient.jar" basedir="jar/">
      <include name="**"/>
      
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.ovd.client.StartConnection"/>
        <attribute name="Class-Path" value="libs/log4j-1.2 libs/gnu-getopt libs/swingx registry.jar jshortcut.jar image4j.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="ovdClient.install" depends="ovdClient.jar">
    <mkdir dir="${ovdClient.dist}"/>

    <copy todir="${ovdClient.dist}">
      <fileset dir="./libs">
        <include name="UlteoOVDClient.jar" />
      </fileset>
    </copy>
  </target>

  <!-- Standalone client part -->

  <target name="standalone.clean" depends="clean">
    <delete dir="${standalone.dist}"/>
  </target>

  <target name="standalone" depends="standalone.clean,precompile">
    <javac srcdir="./src;./src1.4"
           destdir="classes"
           encoding="UTF8"
           target="1.5"
           source="1.5"
           classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar;required_libraries/jai_codec.jar;required_libraries/jai_core.jar;required_libraries/js.jar;"
           includes="org/ulteo/ovd/standalone/Client.java" />
  </target>

  <target name="standalone.jar" depends="standalone,classes2jar">
    <copy todir="jar/ressources">
      <fileset dir="icons"/>
    </copy>

    <mkdir dir="${standalone.dist}"/>

    <jar destfile="${standalone.dist}/OVDStandalone.jar"  basedir="jar/">
      <include name="**" />

      <manifest>
	<attribute name="Main-Class" value="org.ulteo.ovd.standalone.Client" />
	<attribute name="Class-Path" value="gnu-getopt.jar log4j-1.2.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="standalone.install" depends="standalone.jar">
    <copy todir="${standalone.dist}">
      <fileset dir="./libs">
        <include name="OVDStandalone.jar" />
      </fileset>
      <fileset dir="./required_libraries">
        <include name="gnu-getopt.jar" />
        <include name="log4j-1.2.jar" />
      </fileset>
    </copy>
  </target>


  <!-- Applet part -->
  <target name="applet" description="sign applets"  depends="clean,precompile" >
    <javac srcdir="./src;./src1.4" 
           destdir="classes"
           encoding="UTF8"
           target="1.5" 
           source="1.5" 
           classpath="required_libraries/plugin.jar;required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar"
           includes="org/ulteo/ovd/applet/**.java" />
  </target>

  <target name="applet.jar" description="sign applets"  depends="applet,classes2jar" >
    <jar destfile="libs/UlteoOVD.jar"  basedir="jar/">
      <include name="**" />
    </jar>

    <jar destfile="libs/CheckJava-${compile.release}.jar"
         basedir="classes/">
      <include name="org/ulteo/ovd/applet/CheckJava.class"/>
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.ovd.applet.CheckJava"/>
      </manifest>
    </jar>

    <signjar jar="libs/UlteoOVD.jar"
             alias="ulteo"
             storepass="${keystore.password}"
             keystore="${build.cert}/keystore"
             signedjar="libs/ulteo-applet-${compile.release}.jar"/>
    <signjar jar="required_libraries/log4j-1.2.jar"
             alias="ulteo"
             storepass="${keystore.password}"
             keystore="${build.cert}/keystore"
             signedjar="libs/log4j-signed.jar"/>
    <signjar jar="required_libraries/gnu-getopt.jar"
             alias="ulteo"
             storepass="${keystore.password}"
             keystore="${build.cert}/keystore"
             signedjar="libs/getopt-signed.jar"/>
  </target>

  <target name="applet.install"
          description="install applets"
          depends="PDFPrinter.install, applet.jar">
    <mkdir dir="${destdir}${datadir}/ulteo/applets"/>

    <copy todir="${destdir}${datadir}/ulteo/applets">
      <fileset dir="./libs">
        <include name="ulteo-applet-${compile.release}.jar" />
      </fileset>
    </copy>
    <symlink link="${destdir}${datadir}/ulteo/applets/ulteo-applet.jar"
             resource="ulteo-applet-${compile.release}.jar"/>

    <copy todir="${destdir}${datadir}/ulteo/applets">
      <fileset dir="./libs">
        <include name="CheckJava-${compile.release}.jar" />
      </fileset>
    </copy>
    <symlink link="${destdir}${datadir}/ulteo/applets/CheckJava.jar"
             resource="CheckJava-${compile.release}.jar"/>

    <copy todir="${destdir}${datadir}/ulteo/applets">
      <fileset dir="./required_libraries">
        <include name="gnu-getopt.jar" />
        <include name="log4j-1.2.jar" />
      </fileset>
    </copy>
  </target>

  <!-- VDI part -->

  <target name="vdi.clean" depends="clean">
    <delete dir="${vdi.dist}"/>
  </target>

  <target name="vdi" depends="vdi.clean,precompile" >
    <javac srcdir="./src;./src1.4"
           destdir="classes"
           encoding="UTF8"
           target="1.5"
           source="1.5"
           classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar"
           includes="org/ulteo/vdi/Client.java org/ulteo/vdi/fifoclient.java"/>
  </target>

  <target name="vdi.jar" depends="vdi,classes2jar">
    <copy todir="jar/ressources">
      <fileset dir="icons"/>
    </copy>
    <jar destfile="${vdi.dist}/UlteoVDI.jar"  basedir="jar">
      <include name="**" />
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.vdi.Client"/>
        <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="vdi.install" depends="vdi.jar">
    <mkdir dir="${vdi.dist}"/>
    <copy todir="${vdi.dist}">
      <fileset dir="./libs">
        <include name="UlteoVDI.jar" />
      </fileset>
      <fileset dir="./required_libraries">
        <include name="gnu-getopt.jar" />
        <include name="log4j-1.2.jar" />
      </fileset>
    </copy>
  </target>

  <!-- Source tarball part -->

  <target name="dist" description="create a source tarball">
    <mkdir dir="${tar.dir}" />
    <copy todir="${tar.dir}">
      <fileset file="build.xml" />
      <fileset file="README" />
    </copy>
    <mkdir dir="${tar.dir}/required_libraries" />
    <copy todir="${tar.dir}/required_libraries">
      <fileset dir="required_libraries" />
    </copy>
    <mkdir dir="${tar.dir}/src" />
    <copy todir="${tar.dir}/src">
      <fileset dir="src" />
    </copy>
    <mkdir dir="${tar.dir}/src1.4" />
    <copy todir="${tar.dir}/src1.4">
      <fileset dir="src1.4" />
    </copy>

    <mkdir dir="${tar.dir}/keymaps" />
    <copy todir="${tar.dir}/keymaps">
      <fileset dir="keymaps" />
    </copy>

    <tar longfile="gnu" tarfile="${tar}" basedir="./"
         includes="${tar.dir}/**" />
    <gzip zipfile="${tar.gz}" src="${tar}" />

    <delete file="${tar}" />
    <delete dir="${tar.dir}" />
  </target>

  <target name="clean" description="clean files">
    <delete dir="classes"/>
    <delete dir="libs"/>
    <delete dir="jar"/>
  </target>
</project>


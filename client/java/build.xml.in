<?xml version="1.0"?>

<project name="ulteo" default="applet">
    <property name="build.cert" value="/usr/share/ulteo/ovd-cert/"/>
    <property name="keystore.password" value="123456"/>

    <property name="compile.debug" value="false"/>
    <property name="compile.deprecation" value="false"/>
    <property name="compile.optimize" value="true"/>
    <property name="compile.version" value="1.5"/>
    <property name="compile.release" value="0.5.0"/>

    <property name="rdesktop.dist"  value="dist" />

    <property name="prefix"      location="/usr/local" />
    <property name="datadir"     location="${prefix}/share" />
    <property name="destdir"     location="" />

    <property name="version.base" value="99.99~trunk+svn" />
    <property name="version.svn.revno" value="@REVISION@" />

    <property name="tar.dir" value="ovd-applets-${version.base}${version.svn.revno}" />
    <property name="tar"     value="${tar.dir}.tar" />
    <property name="tar.gz"  value="${tar}.gz" />

     <target name="precompile">
         <mkdir dir="classes"/>
         <mkdir dir="classes/ressources"/>
         <mkdir dir="classes/ressources/keymaps"/>
         <copy todir="classes/ressources/keymaps">
           <fileset dir="keymaps"/>
         </copy>

         <mkdir dir="libs"/>
     </target>

    <!-- Rdesktop part -->
    <target name="rdesktop" depends="clean,precompile" description="compile the Java source code to class files">
      <javac srcdir="./src;./src1.4"
             destdir="classes"
             encoding="UTF8"
             target="1.5"
             source="1.5"
             classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar;"
             includes="net/propero/rdp/Rdesktop.java"/>
      <jar destfile="libs/rdesktop.jar" basedir="classes/">
        <include name="**"/>
        <manifest>
          <attribute name="Main-Class" value="net.propero.rdp.Rdesktop"/>
          <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar"/>
        </manifest>
      </jar>
    </target>

    <target name="rdesktop.install" depends="rdesktop">
        <mkdir dir="${rdesktop.dist}"/>

        <copy todir="${rdesktop.dist}">
            <fileset dir="./libs">
                <include name="rdesktop.jar" />
            </fileset>
            <fileset dir="./required_libraries">
                <include name="gnu-getopt.jar" />
                <include name="log4j-1.2.jar" />
            </fileset>
        </copy>
    </target>


     <!-- Integrated client part -->

     <target name="integrated" depends="clean,precompile">
         <javac srcdir="./src;./src1.4"
                destdir="classes"
                encoding="UTF8"
                target="1.5"
                source="1.5"
                classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar;required_libraries/jshortcut.jar;required_libraries/image4j.jar;required_libraries/registry.jar"
                includes="org/ulteo/ovd/integrated/Client.java"/>

         <jar destfile="libs/UlteoOVDIntegratedClient.jar" basedir="classes/">
             <include name="**"/>

             <manifest>
                 <attribute name="Main-Class" value="org.ulteo.ovd.integrated.Client"/>
                 <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar jshortcut.jar image4j.jar registry.jar"/>
             </manifest>
         </jar>
     </target>

    <target name="integrated.install" depends="integrated">
        <mkdir dir="${dist}"/>

        <copy todir="${dist}">
            <fileset dir="./libs">
                <include name="UlteoOVDIntegratedClient.jar" />
            </fileset>
            <fileset dir="./required_libraries">
                <include name="gnu-getopt.jar" />
                <include name="log4j-1.2.jar" />
            </fileset>
        </copy>
    </target>

     

     <!-- Standalone client part -->

     <target name="standalone" depends="clean,precompile">
       <javac srcdir="./src;./src1.4" 
              destdir="classes"
              encoding="UTF8"
              target="1.5" 
              source="1.5" 
              classpath="required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar"
              includes="org/ulteo/ovd/standalone/Client.java" />
       
       <copy todir="classes/ressources">
         <fileset dir="icons"/>
       </copy>

       <jar destfile="libs/OVDStandalone.jar"  basedir="classes/">
         <include name="**" />

         <manifest>
	   <attribute name="Main-Class" value="org.ulteo.ovd.standalone.Client" />
	   <attribute name="Class-Path" value="gnu-getopt.jar log4j-1.2.jar"/>
	 </manifest>
       </jar>
     </target>

    <target name="standalone.install" depends="standalone">
        <mkdir dir="${dist}"/>

        <copy todir="${dist}">
            <fileset dir="./libs">
                <include name="OVDStandalone.jar" />
            </fileset>
            <fileset dir="./required_libraries">
                <include name="gnu-getopt.jar" />
                <include name="log4j-1.2.jar" />
            </fileset>
        </copy>
    </target>


    <!-- Applet part -->
    <target name="applet" description="sign applets"  depends="clean,precompile" >
        <javac srcdir="./src;./src1.4" 
               destdir="classes"
               encoding="UTF8"
               target="1.5" 
               source="1.5" 
               classpath="required_libraries/plugin.jar;required_libraries/log4j-1.2.jar;required_libraries/gnu-getopt.jar"
               includes="org/ulteo/ovd/applet/**.java" />
        
        <jar destfile="libs/UlteoOVD.jar"  basedir="classes/">
            <include name="**" />
        </jar>

        <jar destfile="libs/CheckJava-${compile.release}.jar"
            basedir="classes/">
            <include name="org/ulteo/ovd/applet/CheckJava.class"/>
            <manifest>
                <attribute name="Main-Class" value="org.ulteo.ovd.applet.CheckJava"/>
            </manifest>
        </jar>

        <signjar jar="libs/UlteoOVD.jar"
                 alias="ulteo"
                 storepass="${keystore.password}"
                 keystore="${build.cert}/keystore"
                 signedjar="libs/ulteo-applet-${compile.release}.jar"/>
        <signjar jar="required_libraries/log4j-1.2.jar"
                 alias="ulteo"
                 storepass="${keystore.password}"
                 keystore="${build.cert}/keystore"
                 signedjar="libs/log4j-signed.jar"/>
        <signjar jar="required_libraries/gnu-getopt.jar"
                 alias="ulteo"
                 storepass="${keystore.password}"
                 keystore="${build.cert}/keystore"
                 signedjar="libs/getopt-signed.jar"/>
    </target>

    <target name="applet.install"
            description="install applets"
            depends="applet">
        <mkdir dir="${destdir}${datadir}/ulteo/applets"/>

        <copy todir="${destdir}${datadir}/ulteo/applets">
            <fileset dir="./libs">
                <include name="ulteo-applet-${compile.release}.jar" />
            </fileset>
        </copy>
        <symlink link="${destdir}${datadir}/ulteo/applets/ulteo-applet.jar"
                 resource="ulteo-applet-${compile.release}.jar"/>

        <copy todir="${destdir}${datadir}/ulteo/applets">
            <fileset dir="./libs">
                <include name="CheckJava-${compile.release}.jar" />
            </fileset>
        </copy>
        <symlink link="${destdir}${datadir}/ulteo/applets/CheckJava.jar"
                 resource="CheckJava-${compile.release}.jar"/>

        <copy todir="${destdir}${datadir}/ulteo/applets">
            <fileset dir="./">
                <include name="ulteo-printing-0.5.1.jar" />
            </fileset>
        </copy>
        <symlink link="${destdir}${datadir}/ulteo/applets/ulteo-printing.jar"
                 resource="ulteo-printing-0.5.1.jar"/>

        <copy todir="${destdir}${datadir}/ulteo/applets">
            <fileset dir="./required_libraries">
                <include name="gnu-getopt.jar" />
                <include name="log4j-1.2.jar" />
            </fileset>
        </copy>
    </target>

    <!-- Source tarball part -->
    <target name="dist" description="create a source tarball">
        <mkdir dir="${tar.dir}" />
        <copy todir="${tar.dir}">
            <fileset file="build.xml" />
            <fileset file="README" />
            <fileset file="ulteo-printing-0.5.1.jar" />
        </copy>
        <mkdir dir="${tar.dir}/required_libraries" />
        <copy todir="${tar.dir}/required_libraries">
            <fileset dir="required_libraries" />
        </copy>
        <mkdir dir="${tar.dir}/src" />
        <copy todir="${tar.dir}/src">
            <fileset dir="src" />
        </copy>
        <mkdir dir="${tar.dir}/src1.4" />
        <copy todir="${tar.dir}/src1.4">
            <fileset dir="src1.4" />
        </copy>

        <mkdir dir="${tar.dir}/keymaps" />
        <copy todir="${tar.dir}/keymaps">
            <fileset dir="keymaps" />
        </copy>

        <tar longfile="gnu" tarfile="${tar}" basedir="./"
             includes="${tar.dir}/**" />
        <gzip zipfile="${tar.gz}" src="${tar}" />

        <delete file="${tar}" />
        <delete dir="${tar.dir}" />
    </target>

    <target name="clean" description="clean files">
        <delete dir="classes"/>
        <delete dir="libs"/>
    </target>
 </project>


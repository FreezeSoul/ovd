<?xml version="1.0"?>

<project name="ulteo" default="applet">
  <property name="build.cert" value="certificate"/>
  <property name="keystore.password" value=""/>
  <property name="version" value="@VERSION@" />

  <property name="compile.debug" value="false"/>
  <property name="compile.deprecation" value="false"/>
  <property name="compile.optimize" value="true"/>
  <property name="compile.version" value="1.5"/>
  <property name="compile.release" value="0.5.0"/>
  <property name="mingw32.prefix" value="i586-mingw32msvc-"/>

  <property name="destdir"      location="" />
  <property name="prefix"       location="/usr/local" />
  <property name="datadir"      location="${destdir}${prefix}/share" />
  <property name="bindir"       location="${destdir}${prefix}/bin" />
  <property name="applets.dir"  location="${datadir}/ulteo/applets" />
  <property name="install.dir"  location="${datadir}/java" />

  <property name="distdir"      value="dist" />
  <property name="sdist.source" value="ovd-java-clients" />
  <property name="sdist.name"   value="${sdist.source}-${version}" />
  <property name="sdist.dir"    location="${distdir}/${sdist.name}" />

  <path id="minimal.path" path="required_libraries/log4j-1.2.jar:
                                required_libraries/gnu-getopt.jar"/>

  <target name="clean" description="clean files">
    <delete dir="classes"/>
    <delete dir="jar"/>
    <delete dir="libs"/>
    <exec executable="make" failonerror="true" dir="windowsPathsJNI" >
      <arg value="clean" />
    </exec>
  </target>

  <target name="precompile">
    <antcall target="clean" />
    <mkdir dir="classes"/>
    <mkdir dir="libs"/>
    <mkdir dir="dist"/>
    <mkdir dir="jar/ressources/keymaps"/>
    <copy todir="jar/ressources/keymaps">
      <fileset dir="keymaps"/>
    </copy>
  </target>

  <target name="classes2jar" description="copy classes/** to jar/">
    <copy todir="jar/">
      <fileset dir="classes" />
    </copy>
  </target>


  <!-- Rdesktop part -->

  <target name="rdesktop" description="compile all RDesktop class">
    <antcall target="precompile" />
    <javac srcdir="src;src1.4" destdir="classes" encoding="UTF8"
           target="1.5" source="1.5" includes="net/propero/rdp/Rdesktop.java" >
      <classpath refid="minimal.path" />
    </javac>
  </target>

  <target name="rdesktop.jar" depends="rdesktop" description="create jar file">
    <antcall target="classes2jar" />
    <jar destfile="libs/rdesktop.jar" basedir="jar/">
      <manifest>
        <attribute name="Main-Class" value="net.propero.rdp.Rdesktop"/>
        <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="rdesktop.install" depends="rdesktop.jar">
    <copy file="libs/rdesktop.jar" todir="${install.dir}">
      <filelist dir="required_libraries" files="gnu-getopt.jar log4j-1.2.jar" />
    </copy>
  </target>


  <!-- RDP Client part -->

  <target name="rdpClient">
    <antcall target="precompile" />
    <javac srcdir="src;src1.4" destdir="classes" encoding="UTF8"
           target="1.5" source="1.5" includes="org/ulteo/rdp/RdpClient.java">
      <classpath refid="minimal.path" />
    </javac>
  </target>

  <target name="rdpClient.jar" depends="rdpClient">
    <antcall target="classes2jar" />
    <jar destfile="libs/RDPClient.jar" basedir="jar/">
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.rdp.RdpClient"/>
        <attribute name="Class-Path" value="log4j-1.2.jar gnu-getopt.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="rdpClient.install" depends="rdpClient.jar">
    <copy file="libs/RDPClient.jar" todir="${install.dir}">
      <filelist dir="required_libraries" files="gnu-getopt.jar log4j-1.2.jar" />
    </copy>
  </target>


  <!-- PDFPrinter part -->

 <target name="PDFPrinter" description="compile all PDFPrinter class">
   <antcall target="precompile" />
   <javac srcdir="src" destdir="classes" encoding="UTF8" target="1.5" source="1.5"
          includes="org/ulteo/ovd/printer/PrinterApplet.java">
     <classpath>
       <pathelement location="required_libraries/jai_codec.jar"/>
       <pathelement location="required_libraries/jai_core.jar"/>
       <pathelement location="required_libraries/js.jar"/>
     </classpath>
   </javac>
 </target>

 <target name="PDFPrinter.jar" depends="PDFPrinter" description="create jar file">
   <antcall target="classes2jar" />
   <copy todir="jar/org/jpedal/res">
     <fileset dir="src/org/jpedal/res"/>
   </copy>
   <jar destfile="libs/PDFPrinter.jar" basedir="jar/">
     <include name="**"/>
     <manifest>
       <attribute name="Main-Class" value="org.ulteo.ovd.printer.PrinterApplet"/>
     </manifest>
   </jar>
   <signjar jar="libs/PDFPrinter.jar"
            alias="ulteo"
            storepass="${keystore.password}"
            keystore="${build.cert}/keystore"
            signedjar="libs/PDFPrinter-${compile.release}.jar"/>
 </target>

 <target name="PDFPrinter.install" description="install applets"
         depends="PDFPrinter.jar">
   <copy todir="${applets.dir}">
     <fileset dir="libs">
       <include name="PDFPrinter-${compile.release}.jar" />
     </fileset>
   </copy>
   <symlink link="${applets.dir}/PDFPrinter.jar"
            resource="PDFPrinter-${compile.release}.jar"/>
 </target>


  <!-- Ovd External Apps Client -->

   <target name="ovdExternalAppsClient">
   <antcall target="precompile" />
    <javac srcdir="src;src1.4" destdir="classes" encoding="UTF8"
	   target="1.5" source="1.5"
	   includes="org/ulteo/ovd/client/StartTokenAuth.java">
      <classpath>
        <fileset dir="required_libraries">
          <include name="*.jar" />
          <exclude name="plugin.jar" />
        </fileset>
      </classpath>
    </javac>
  </target>

   <target name="ovdExternalAppsClient.jar" depends="ovdExternalAppsClient">
     <antcall target="classes2jar" />
     <copy todir="jar/org/jpedal/res">
       <fileset dir="src/org/jpedal/res"/>
     </copy>
     <unjar src="required_libraries/gnu-getopt.jar" dest="jar">
       <filelist dir="required_libraries"
                 files="log4j-1.2.jar,registry.jar
			            jshortcut.jar,image4j.jar,ini4j.jar" />
     </unjar>
     <jar destfile="libs/OVDExternalAppsClient.jar" basedir="jar/">
       <manifest>
         <attribute name="Main-Class"
                    value="org.ulteo.ovd.client.StartTokenAuth"/>
       </manifest>
     </jar>
   </target>

   <target name="ovdExternalAppsClient.install"
           depends="ovdExternalAppsClient.jar">
     <copy file="libs/OVDExternalAppsClient.jar" todir="${install.dir}" />
     <copy file="scripts/OVDExternalAppsClient" todir="${bindir}" />
   </target>


  <!-- OVD native client part -->

  <target name="ovdNativeClient">
    <antcall target="precompile" />
    <javac srcdir="src;src1.4" destdir="classes" encoding="UTF8"
           target="1.5" source="1.5"
           includes="org/ulteo/ovd/client/StartConnection.java">
      <classpath>
        <fileset dir="required_libraries">
          <include name="*.jar" />
          <exclude name="plugin.jar" />
        </fileset>
      </classpath>
    </javac>
  </target>

  <target name="ovdNativeClient_jar">
    <antcall target="classes2jar" />
    <!-- Auto-generated exec ant command for i18n fonctionality -->
    @MESSAGE_LANGS@
    <copy todir="jar/pics">
      <fileset dir="icons" />
    </copy>
    <copy todir="jar/org/jpedal/res">
      <fileset dir="src/org/jpedal/res"/>
    </copy>
  </target>

  <target name="ovdNativeClient_install">
    <copy file="libs/OVDNativeClient.jar" todir="${install.dir}" />
    <copy file="scripts/OVDNativeClient" todir="${bindir}" />
    <copy file="misc/ulteo-ovd-native-client.desktop"
          todir="${datadir}/applications" />
    <copy file="icons/ulteo-ovd-native-client.png" todir="${datadir}/icons" />
  </target>

  <target name="ovdNativeClient.jar" depends="ovdNativeClient">
    <unjar dest="jar">
      <filelist dir="required_libraries"
                files="gnu-getopt.jar, log4j-1.2.jar, registry.jar,
                       jshortcut.jar, image4j.jar, ini4j.jar" />
    </unjar>
    <antcall target="ovdNativeClient_jar" />
    <jar destfile="libs/OVDNativeClient.jar" basedir="jar/">
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.ovd.client.StartConnection"/>
      </manifest>
    </jar>
  </target>

  <target name="ovdNativeClient.install" depends="ovdNativeClient.jar">
    <antcall target="ovdNativeClient_install" />
  </target>

  <target name="ovdNativeClient.debian" depends="ovdNativeClient">
    <unjar src="required_libraries/ini4j.jar" dest="jar" />
    <antcall target="ovdNativeClient_jar" />
    <jar destfile="libs/OVDNativeClient.jar" basedir="jar/">
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.ovd.client.StartConnection"/>
        <attribute name="Class-Path" value="/usr/share/java/gnu-getopt.jar
                                            /usr/share/java/log4j-1.2.jar"/>
      </manifest>
    </jar>
    <antcall target="ovdNativeClient_install" />
  </target>


  <!-- Applet part -->

  <target name="applet">
    <antcall target="precompile" />
    <javac srcdir="src;src1.4" destdir="classes" encoding="UTF8"
           target="1.5" source="1.5" includes="org/ulteo/ovd/applet/**.java" >
      <classpath>
        <path refid="minimal.path" />
        <pathelement location="required_libraries/plugin.jar" />
      </classpath>
    </javac>
    <exec executable="make" failonerror="true" dir="windowsPathsJNI">
       <env key="JAVAHOME"  path="${java.home}/.." />
       <env key="BINPREFIX" value="${mingw32.prefix}" />
    </exec>
  </target>

  <target name="applet.jar" description="sign jar applets" depends="applet" >
    <antcall target="classes2jar" />
    <copy file="windowsPathsJNI/libWindowsPaths.dll"
          todir="jar/ressources/WindowsLibs" />
    <jar destfile="libs/ulteo-applet-${compile.release}.jar" basedir="jar/">
      <include name="**" />
    </jar>
    <jar destfile="libs/CheckJava-${compile.release}.jar" basedir="classes/">
      <include name="org/ulteo/ovd/applet/CheckJava.class"/>
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.ovd.applet.CheckJava"/>
      </manifest>
    </jar>
    <signjar destDir="libs" alias="ulteo" storepass="${keystore.password}"
             keystore="${build.cert}/keystore" >
        <fileset dir="required_libraries" includes="log4j-1.2.jar" />
        <fileset dir="libs" includes="ulteo-applet-${compile.release}.jar" />
    </signjar>
  </target>

  <target name="applet.install" description="install applets"
          depends="PDFPrinter.install, applet.jar">
    <copy todir="${applets.dir}">
      <filelist dir="libs" files="log4j-1.2.jar
         ulteo-applet-${compile.release}.jar CheckJava-${compile.release}.jar" />
    </copy>
    <symlink link="${applets.dir}/ulteo-applet.jar"
             resource="ulteo-applet-${compile.release}.jar"/>
    <symlink link="${applets.dir}/CheckJava.jar"
             resource="CheckJava-${compile.release}.jar"/>
  </target>


  <!-- VDI part -->

  <target name="vdi">
    <antcall target="precompile" />
    <copy todir="jar/org/jpedal/res">
      <fileset dir="src/org/jpedal/res"/>
    </copy>
    <javac srcdir="src:src1.4" destdir="classes" encoding="UTF8"
           target="1.5" source="1.5" includes="org/ulteo/vdi/Client.java">
      <classpath refid="minimal.path" />
    </javac>
  </target>

  <target name="vdi.jar" depends="vdi">
    <antcall target="classes2jar" />
    <jar destfile="libs/UlteoVDI.jar"  basedir="jar">
      <include name="**" />
      <manifest>
        <attribute name="Main-Class" value="org.ulteo.vdi.Client"/>
        <attribute name="Class-Path" value="/usr/share/java/log4j-1.2.jar /usr/share/java/gnu-getopt.jar"/>
      </manifest>
    </jar>
  </target>

  <target name="vdi.install" depends="vdi.jar">
    <copy file="libs/UlteoVDI.jar" todir="${install.dir}" />
  </target>


  <!-- Source tarball part -->

  <target name="dist" description="create a source tarball">
    <delete dir="${sdist.dir}" />
    <copy todir="${sdist.dir}">
      <fileset dir="." includes="build.xml README">
        <include name="src*/**" />
        <include name="required_libraries/*" />
        <include name="keymaps/*" />
        <include name="scripts/*" />
        <include name="icons/*" />
        <include name="po/*" />
        <include name="misc/*" />
        <include name="windowsPathsJNI/*" />
      </fileset>
    </copy>
    <tar destfile="${distdir}/${sdist.name}.tar" longfile="gnu"
         basedir="${distdir}" includes="${sdist.name}/**" />
    <gzip zipfile="${distdir}/${sdist.name}.tar.gz"
          src="${distdir}/${sdist.name}.tar" />
    <delete dir="${sdist.dir}" />
    <delete file="${distdir}/${sdist.name}.tar" />
  </target>

</project>

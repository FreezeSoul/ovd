<?xml version="1.0"?>

<project name="ulteo" default="compile">
    <property name="build.cert" value="/usr/share/ulteo/ovd-cert/"/>
    <property name="keystore.password" value="123456"/>

    <property name="compile.debug" value="false"/>
    <property name="compile.deprecation" value="false"/>
    <property name="compile.optimize" value="true"/>
    <property name="compile.version" value="1.5"/>
    <property name="compile.release" value="0.3.2"/>

    <property name="prefix"      location="/usr/local" />
    <property name="datadir"     location="${prefix}/share" />
    <property name="destdir"     location="" />

    <property name="version.base" value="99.99~trunk+svn" />
    <property name="version.svn.revno" value="@REVISION@" />

    <property name="tar.dir" value="ovd-applets-${version.base}${version.svn.revno}" />
    <property name="tar"     value="${tar.dir}.tar" />
    <property name="tar.gz"  value="${tar}.gz" />

    <target name="compile"
            description="compile the Java source code to class files">
        <mkdir dir="classes"/>
        <mkdir dir="libs"/>

        <!-- 
            the following 'classpath="${java.home}/lib/plugin.jar"' is
            needed when using Sun JDK, useless when using OpenJDK 
         -->
        <javac srcdir="./src"
               destdir="classes"
               target="${compile.version}"
               source="${compile.version}"
               classpath="${java.home}/lib/plugin.jar"
               debug="${compile.debug}"
               optimize="${compile.optimize}"
               deprecation="${compile.deprecation}" >
        </javac>


        <jar destfile="libs/vncviewer.jar"
             basedir="classes/">
            <include name="org/vnc/**"/>
            <manifest>
                <attribute name="Main-Class" value="org.vnc.SimpleClient.Viewer"/>
            </manifest>
        </jar>

        <jar destfile="libs/sshvnc.jar"
             basedir="classes/">
            <include name="com/sshtools/**"/>
            <exclude name="com/sshtools/j2ssh/sftp" />
            <include name="org/vnc/*"/>
            <include name="org/vnc/rfbcaching/*"/>
            <include name="org/sshvnc/*"/>

            <manifest>
                <attribute name="Main-Class" value="org.sshvnc.Viewer"/>
            </manifest>
        </jar>

        <jar destfile="libs/CheckJava-${compile.release}.jar"
            basedir="classes/">
            <include name="org/ulteo/applet/CheckJava.class"/>
            <manifest>
                <attribute name="Main-Class" value="org.ulteo.applet.CheckJava"/>
            </manifest>
        </jar>

        <jar destfile="libs/UlteoOVD.jar"
            basedir="classes/">
            <include name="com/sshtools/**"/>
            <exclude name="com/sshtools/j2ssh/sftp" />
            <include name="org/vnc/*"/>
            <include name="org/vnc/rfbcaching/*"/>
            <include name="org/sshvnc/*"/>
            <include name="org/ulteo/**"/>
            <manifest>
                <attribute name="Main-Class" value="org.ulteo.OvdClient"/>
            </manifest>
        </jar>

    </target>

    <target name="sign"
            description="sign applets"  depends="compile" >

        <signjar jar="libs/UlteoOVD.jar"
                 alias="ulteo"
                 storepass="${keystore.password}"
                 keystore="${build.cert}/keystore"
                 signedjar="libs/ulteo-applet-${compile.release}.jar"/>
    </target>

    <target name="install"
            description="install applets"
            depends="sign">
        <mkdir dir="${destdir}${datadir}/ulteo/applets"/>

        <copy todir="${destdir}${datadir}/ulteo/applets">
            <fileset dir="./libs">
                <include name="ulteo-applet-${compile.release}.jar" />
            </fileset>
        </copy>
        <symlink link="${destdir}${datadir}/ulteo/applets/ulteo-applet.jar"
                 resource="ulteo-applet-${compile.release}.jar"/>

        <copy todir="${destdir}${datadir}/ulteo/applets">
            <fileset dir="./libs">
                <include name="CheckJava-${compile.release}.jar" />
            </fileset>
        </copy>
        <symlink link="${destdir}${datadir}/ulteo/applets/CheckJava.jar"
                 resource="CheckJava-${compile.release}.jar"/>

        <copy todir="${destdir}${datadir}/ulteo/applets">
            <fileset dir="./">
                <include name="ulteo-printing-0.5.1.jar" />
            </fileset>
        </copy>
        <symlink link="${destdir}${datadir}/ulteo/applets/ulteo-printing.jar"
                 resource="ulteo-printing-0.5.1.jar"/>
    </target>

    <target name="dist" description="create a source tarball">
        <mkdir dir="${tar.dir}" />
        <copy todir="${tar.dir}">
            <fileset file="build.xml" />
            <fileset file="README" />
            <fileset file="ulteo-printing-0.5.1.jar" />
        </copy>
        <mkdir dir="${tar.dir}/required_libraries" />
        <copy todir="${tar.dir}/required_libraries">
            <fileset dir="required_libraries" />
        </copy>
        <mkdir dir="${tar.dir}/src" />
        <copy todir="${tar.dir}/src">
            <fileset dir="src" />
        </copy>

        <tar longfile="gnu" tarfile="${tar}" basedir="./"
             includes="${tar.dir}/**" />
        <gzip zipfile="${tar.gz}" src="${tar}" />

        <delete file="${tar}" />
        <delete dir="${tar.dir}" />
    </target>
    <target name="clean" description="clean files">
        <delete dir="classes"/>
        <delete dir="libs"/>
    </target>
 </project>


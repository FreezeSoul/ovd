#!/bin/bash
# Copyright (C) 2008 Ulteo SAS
# http://www.ulteo.com
# Author Gauvain POCENTEK <gauvain@ulteo.com>
# Author Julien LANGLOIS <julien@ulteo.com>
#
# All rights reserved.

waitpid() {
    local pid=$1
    local timeout=$2
    local t0=$(date +"%s")

    while [ -d /proc/$1 ]; do
        sleep 0.5

        if [ $timeout ]; then
            local t1=$(date +"%s")
            [ $(($t1-$t0)) -gt $2 ] && return 1
        fi
    done
}

CONF_FILE=@SYSCONFDIR@/ulteo-ovd.conf
BIN_DIR=@DATADIR@/ulteo-ovd

. /lib/lsb/init-functions

PIDFILE="/var/run/ulteo-ovdd.pid"
PROGRAM=$BIN_DIR/ulteo-ovdd

    # Start the services
do_start () {
    log_begin_msg "Starting ulteo-ovd daemon..."
    # Mount /proc if not done
    if [ ! -f /proc/mounts ]; then
        mount -t proc none /proc
    fi

    grep -q /dev/pts /etc/mtab 
    if [ $? -ne 0 ]; then
        mkdir -p /dev/pts
        mount -t devpts none /dev/pts
    fi

    if [ -f $PIDFILE ]; then
        if ps $(cat $PIDFILE); then
            echo "ulteo-ovdd is already running"
            return
        else
            rm $PIDFILE
        fi
    fi

    # TODO: check if the services are already running
    /etc/init.d/ssh start || true
    /etc/init.d/portmap start || true
    /etc/init.d/dbus start || true
    /etc/init.d/cron start || true
    /etc/init.d/cupsys start || true

    for service in $EXTRA_SERVICES; do # from the config file
        /etc/init.d/$service start || true
    done

    # Start the daemon (well, not exactly a daemon...)
    $PROGRAM --daemonize --pid "$PIDFILE"

    log_end_msg 0
}

do_stop () {
    log_begin_msg "Stopping ulteo-ovd daemon..."

    # Kill apps
    if [ -f $PIDFILE ]; then
        local pid=$(cat $PIDFILE)
        kill $pid
        waitpid $pid 5 && rm $PIDFILE || true
    fi

    # Stop services
    /etc/init.d/ssh stop || true
    /etc/init.d/portmap stop || true
    /etc/init.d/dbus stop || true
    /etc/init.d/cron stop || true
    /etc/init.d/cupsys stop || true

    for service in $EXTRA_SERVICES; do # from the config file
        /etc/init.d/$service stop || true
    done

    grep -q /dev/pts /etc/mtab 
    if [ $? -eq 0 ]; then
        umount /dev/pts
    fi

    if [ -f /proc/mounts ]; then
        umount /proc
    fi

    log_end_msg 0
}

case $1 in
    start)
        do_start;;

    stop)
        do_stop;;

    restart|force-reload)
        do_stop
        do_start
        ;;
    *)
        log_success_msg "Usage: /etc/init.d/ulteo-ovd {start|stop|force-reload|restart}";;
esac

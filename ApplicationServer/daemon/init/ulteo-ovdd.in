#!/bin/sh
# Copyright (C) 2008-2010 Ulteo SAS
# http://www.ulteo.com
# Author Gauvain POCENTEK <gauvain@ulteo.com> 2008
# Author Julien LANGLOIS <julien@ulteo.com> 2008, 2010
#
# All rights reserved.

waitpid() {
    local pid=$1
    local timeout=$2
    local t0=$(date +"%s")

    while [ -d /proc/$1 ]; do
        sleep 0.5

        if [ -n "$timeout" ]; then
            local t1=$(date +"%s")
            [ $(($t1-$t0)) -gt $2 ] && return 1
        fi
    done

    return 0
}

wait_stop() {
    local pid=$1
    local limit=100

    SPOOL=/var/spool/ulteo-ovd
    . $CONF_FILE

    local cnt=0
    while kill -0 $pid 2>/dev/null
    do
	cnt=`expr $cnt + 1`
	if [ $cnt -gt $limit ] || [ -n "$zero_session" ]; then
            return 1
        fi

        local nb_sessions=$(find $SPOOL/sessions -maxdepth 1 -mindepth 1 -type d -printf "%f\n" 2>/dev/null |wc -l)
        [ $nb_sessions -eq 0 ] && local zero_session=1
        log_action_cont_msg "$nb_sessions remaining"

	sleep 5
    done
}


CONF_FILE=@SYSCONFDIR@/ulteo-ovd.conf
BIN_DIR=@DATADIR@/ulteo-ovd

. /lib/lsb/init-functions

PIDFILE="/var/run/ulteo-ovdd.pid"
PROGRAM=$BIN_DIR/ulteo-ovdd

    # Start the services
do_start () {
    log_begin_msg "Starting ulteo-ovd daemon..."
    # Mount /proc if not done
    if [ ! -f /proc/mounts ]; then
        mount -t proc none /proc
    fi

    grep -q /dev/pts /etc/mtab 
    if [ $? -ne 0 ]; then
        mkdir -p /dev/pts
        mount -t devpts none /dev/pts
    fi

    if [ -f $PIDFILE ]; then
        if ps $(cat $PIDFILE); then
            echo "ulteo-ovdd is already running"
            return
        else
            rm $PIDFILE
        fi
    fi

    # TODO: check if the services are already running
    /etc/init.d/ssh start || true
    /etc/init.d/portmap start || true
    /etc/init.d/dbus start || true
    /etc/init.d/cron start || true
    /etc/init.d/cupsys start || true

    for service in $EXTRA_SERVICES; do # from the config file
        /etc/init.d/$service start || true
    done

    # Start the daemon (well, not exactly a daemon...)
    $PROGRAM --daemonize --pid "$PIDFILE"

    log_end_msg 0
}

do_stop () {
    log_begin_msg "Stopping ulteo-ovd daemon..."

    if [ ! -f $PIDFILE ]; then
        log_warning_msg "NOT RUNNING"
        return 1
    fi

    if [ ! -f /proc/mounts ]; then
        log_warning_msg "/proc not mounted"
        return 1
    fi


    pidofproc -p $PIDFILE >/dev/null
    if [ $? -ne 0 ]; then
        log_warning_msg "NOT RUNNING"
        rm $PIDFILE

    else
        # Kill apps
        local pid=$(pidofproc -p $PIDFILE)
        kill $pid
        waitpid $pid 5
        if [ $? -eq 1 ]; then
            log_action_begin_msg "Purging sessions"
            wait_stop $pid
            log_action_end_msg $?
        fi
    fi

    # Stop services
    /etc/init.d/ssh stop || true
    /etc/init.d/portmap stop || true
    /etc/init.d/dbus stop || true
    /etc/init.d/cron stop || true
    /etc/init.d/cupsys stop || true

    for service in $EXTRA_SERVICES; do # from the config file
        /etc/init.d/$service stop || true
    done

    grep -q /dev/pts /etc/mtab 
    if [ $? -eq 0 ]; then
        umount /dev/pts
    fi

    if [ -f /proc/mounts ]; then
        umount /proc
    fi

    log_end_msg 0
}

case $1 in
    start)
        do_start;;

    stop)
        do_stop;;

    restart|force-reload)
        do_stop
        do_start
        ;;
    *)
        log_success_msg "Usage: /etc/init.d/ulteo-ovd {start|stop|force-reload|restart}";;
esac

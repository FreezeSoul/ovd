#!/bin/sh

set_admin () {
    LOGIN=
    PASS1=
    PASS2=
    CONFFILE=@CONFFILE@

    echo -n "Admin login: "
    while [ -z $LOGIN ]; do
        read LOGIN
        if [ -z $LOGIN ]; then
            echo "You need to have something here... please retry: "
        fi
    done

    stty_orig=`stty -g`
    while [ -z $PASS1 -o $PASS1 != $PASS2 ]; do
        echo -n "Password: "
        while [ -z $PASS1 ]; do
            stty -echo
            read PASS1
            stty $stty_orig
            echo
            if [ -z $PASS1 ]; then
                echo -n "You need to have something here... please retry: "
            fi
        done
        echo -n "Retype password: "
        while [ -z $PASS2 ]; do
            stty -echo
            read PASS2
            stty $stty_orig
            echo
            if [ -z $PASS2 ]; then
                echo -n "You need to have something here... please retry: "
            fi
        done

        if [ $PASS1 != $PASS2 ]; then
            echo "Passwords don't match... try again."
            unset PASS1
            unset PASS2
        fi
    done

    PASS=$(echo -n $PASS1 | md5sum | cut -d " " -f 1)
    unset PASS1
    unset PASS2

    sed -r -i "s,^(.*SESSIONMANAGER_ADMIN_LOGIN.*').*('.*)$,\1$LOGIN\2," $CONFFILE
    sed -r -i "s,^(.*SESSIONMANAGER_ADMIN_PASSWORD.*').*('.*)$,\1$PASS\2," $CONFFILE

    exit 0
}

show_config () {
    echo "ConfDir: @CONFDIR@"
    echo "WebDir: @WEBDIR@"
    exit 0
}

get_chroot () {
    URL=http://www.ulteo.com/main/downloads/ulteo-ovd.php
    if [ $2 ]; then
        mkdir -p $2
        OUTPUT=$2/base.tar.gz
    else
        # we shouldn't need this but...
        mkdir -p @WEBDIR@
        OUTPUT=@WEBDIR@/base.tar.gz
    fi
    wget $URL -O $OUTPUT
}

usage () {
    echo "$0: configure Ulteo OpenVirtual Desktop Session Manager"
    echo "$0 command [options]"
    echo
    echo "command can be:"
    echo "set-admin:"
    echo "    set login and password for the SM admin"
    echo "get-chroot [path]:"
    echo "    download a default chroot and stores it as path/base.tar.gz if specified"
    echo "    (default: @WEBDIR@/base.tar.gz)"
    echo "config:"
    echo "    display some SM configuration paths"
    echo "help:"
    echo "    display this help"
}

case $1 in
    set-admin)
        set_admin;;
    config)
        show_config;;
    get-chroot)
        get_chroot;;
    help)
        usage
        exit 0;;
    *)
        usage
        exit 1;;
esac

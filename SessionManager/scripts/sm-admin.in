#!/bin/sh
# Copyright (C) 2008 Ulteo SAS
# Author: Gauvain Pocentek <gauvain@ulteo.com>
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation, version 2
# of the License.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

if [ $UID != 0 ]; then
    echo "You need to be root. Aborting."
fi

set_admin () {
    LOGIN=
    PASS1=
    PASS2=
    CONFFILE=@CONFFILE@

    echo -n "Admin login: "
    while [ -z $LOGIN ]; do
        read LOGIN
        if [ -z $LOGIN ]; then
            echo "You need to have something here... please retry: "
        fi
    done

    stty_orig=`stty -g`
    while [ -z $PASS1 -o $PASS1 != $PASS2 ]; do
        echo -n "Password: "
        while [ -z $PASS1 ]; do
            stty -echo
            read PASS1
            stty $stty_orig
            echo
            if [ -z $PASS1 ]; then
                echo -n "You need to have something here... please retry: "
            fi
        done
        echo -n "Retype password: "
        while [ -z $PASS2 ]; do
            stty -echo
            read PASS2
            stty $stty_orig
            echo
            if [ -z $PASS2 ]; then
                echo -n "You need to have something here... please retry: "
            fi
        done

        if [ $PASS1 != $PASS2 ]; then
            echo "Passwords don't match... try again."
            unset PASS1
            unset PASS2
        fi
    done

    PASS=$(echo -n $PASS1 | md5sum | cut -d " " -f 1)
    unset PASS1
    unset PASS2

    sed -r -i "s,^(.*SESSIONMANAGER_ADMIN_LOGIN.*').*('.*)$,\1$LOGIN\2," $CONFFILE
    sed -r -i "s,^(.*SESSIONMANAGER_ADMIN_PASSWORD.*').*('.*)$,\1$PASS\2," $CONFFILE

    exit 0
}

show_config () {
    echo "ConfDir: @CONFDIR@"
    echo "WebDir: @WEBDIR@"
    exit 0
}

get_chroot () {
    URL=http://www.ulteo.com/main/downloads/ulteo-ovd.php
    if [ $2 ]; then
        mkdir -p $2
        OUTPUT=$2/base.tar.gz
    else
        # we shouldn't need this but...
        mkdir -p @WEBDIR@
        OUTPUT=@WEBDIR@/base.tar.gz
    fi
    wget $URL -O $OUTPUT
}

usage () {
    echo "Usage: $0 command [options]"
    echo "$0: configure Ulteo OpenVirtual Desktop Session Manager"
    echo
    echo "command can be:"
    echo "  set-admin         set login and password for the SM admin"
    echo "  get-chroot [path] download a default chroot and stores it as path/base.tar.gz if specified"
    echo "                    (default: @WEBDIR@/base.tar.gz)"
    echo "  config            display some SM configuration paths"
    echo "  help              display this help"
    echo "  version           display version informations"
}

case $1 in
    set-admin)
        set_admin;;
    config)
        show_config;;
    get-chroot)
        get_chroot;;
    help)
        usage
        exit 0;;
    version)
        echo $(basename $0) @PKG_VERSION@
        exit 0;;
    *)
        usage
        exit 1;;
esac

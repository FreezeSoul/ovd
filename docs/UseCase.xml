<?xml version="1.0" ?>
<!DOCTYPE article PUBLIC "-//Norman Walsh//DTD DocBk XML V4.0//EN"
          "http://www.oasis-open.org/docbook/xml/4.0/docbookx.dtd">
<article>
  <articleinfo>
    <title>Ulteo Online Desktop Installation UseCase</title>
  </articleinfo>
  <section>
    <title>Project description</title>
    <para>
      We want to offer OpenOffice.org online. We use 2 servers: 
    </para>
    <itemizedlist>
      <listitem>
        <para><emphasis role="strong">fire.ulteo.com</emphasis> is the session manager</para>
      </listitem>
      <listitem>
        <para><emphasis role="strong">connectme.ulteo.com</emphasis>is the applications server</para>
      </listitem>
    </itemizedlist>
    <para>
      The systems have to be <emphasis role="strong">Ubuntu hardy</emphasis>. The operations need to be made as <emphasis>root</emphasis>.
    </para>

    <itemizedlist>
      <listitem>
        <para>To enable the root account :
	  <screen>
	    <![CDATA[
$ sudo passwd
$ su]]>
	  </screen>
	</para>
      </listitem>
    </itemizedlist>
  </section>

  <section>
    <title>Session manager server installation (fire.ulteo.com)</title>
    <itemizedlist>
      <listitem>
	<para>
	  Add the Ulteo repository to <emphasis>sources.list</emphasis>and update the system :
	</para>
        <screen>
	  <![CDATA[
# echo "deb http://mathurine.ulteo.com/~gauvain/archive/ulteo od hardy" >> /etc/apt/sources.list
# apt-get update
# apt-get upgrade]]>
	</screen>
      </listitem>
      <listitem>
        <para>Install the package ulteo-od-session-manager :</para>
        <screen>
	  <![CDATA[
# apt-get install ulteo-od-session-manager]]>
	</screen>
      </listitem>
    </itemizedlist>
    <para>
      A list of servers authorized to connect to the session manager will be asked. In our case the server is <emphasis>connectme.ulteo.com</emphasis>:
    </para>
    <para>
      <inlinemediaobject>
	<imageobject>
          <imagedata fileref="img/fqdns.png"/>
	</imageobject>
      </inlinemediaobject>
    </para>
    <para>
      The session manager is available at <emphasis>http://fire.ulteo.com/sessionmanager</emphasis>.
      The <emphasis>Server</emphasis> field is empty because no application server has registered yet.
      The session manager server is ready. 
    </para>
  </section>
  <section>
    <title>
      Applications server installation (connectme.ulteo.com)
    </title>
    <itemizedlist>
      <listitem>
        <para>
          Add the Ulteo repository to <emphasis>sources.list</emphasis> and update the system : 
        </para>
        <screen>
	  <![CDATA[
# echo "deb http://mathurine.ulteo.com/~gauvain/archive/ulteo od hardy" >> /etc/apt/sources.list
# apt-get update
# apt-get upgrade]]>
        </screen>
      </listitem>
      <listitem>
        <para>
          Install the package <emphasis>ulteo-od</emphasis> which will request informations and configure everything: 
        </para>
        <screen>
	  <![CDATA[
# apt-get install ulteo-od]]>
	</screen>
      </listitem>
      <listitem>
        <para>
	  The first question is about the download url of the Application System archive (tarball).
	  There are 2 systems available at the moment:
	</para>
        <itemizedlist>
          <listitem>
            <para>
              a system which only contain OpenOffice: <ulink url="http://firex.ulteo.com/~gauvain/base.tar.gz">http://firex.ulteo.com/~gauvain/base.tar.gz</ulink>
            </para>
          </listitem>
          <listitem>
            <para>
              a system which contain a full Kde desktop with OpenOffice and Firefox : <ulink url="http://firex.ulteo.com/~gauvain/base-douanes.tgz">http://firex.ulteo.com/~gauvain/base-douanes.tgz</ulink>
            </para>
          </listitem>
        </itemizedlist>
        <para>
          <inlinemediaobject>
            <imageobject>
              <imagedata fileref="img/dl.png"/>
            </imageobject>
            <textobject>
              <phrase>Debconf chroot question</phrase>
            </textobject>
          </inlinemediaobject>
        </para>
      </listitem>
      <listitem>
        <para>
	  The next question needs an answer if an HTTP authentication is needed for the download.
	  We don't need it in our example, thus we leave the entry empty. 
	  A password is asked if an username is typed.
	</para>
      </listitem>
      <listitem>
        <para>
          Next question deals with the chroot location on the server. 
	  We select <emphasis>/opt/connectme</emphasis>:
	</para>
	<para>
          <inlinemediaobject>
            <imageobject>
              <imagedata fileref="img/chrootpath.png"/>
            </imageobject>
            <textobject>
              <phrase>Debconf chroot installation question</phrase>
            </textobject>
          </inlinemediaobject>
        </para>
      </listitem>
      <listitem>
        <para>
          Next question asks the full qualified domain name (host and domain names). 
	  This <emphasis>fqdn</emphasis> is used by the session manager to validate the requests done by the application server. If the fqdn isn't listed in the session manager configuration, requests will fail. 
	  Our server is called <emphasis>connectme.ulteo.com</emphasis>.
	  You <emphasis role="strong">need</emphasis> an fqdn.
	  If you can't authenticate with the domain name (no DNS server on a LAN for instance), you'll have to set up a has name =&gt; ip in the session manager configuration. 
	</para>
	<para>
	  <inlinemediaobject>
            <imageobject>
              <imagedata fileref="img/fqdn.png"/>
            </imageobject>
            <textobject>
	      <phrase>debconf fqdn question</phrase>
            </textobject>
	  </inlinemediaobject>
        </para>
      </listitem>
      <listitem>
        <para>
          Next question asks for the session manager to use. 
	  Type the url used to test the session manager
	</para>
	<para>
          <inlinemediaobject>
            <imageobject>
              <imagedata fileref="img/smurl.png"/>
            </imageobject>
            <textobject>
              <phrase>debconf session manager base url question</phrase>
            </textobject>
          </inlinemediaobject>
        </para>
      </listitem>
      <listitem>
	<para>
          The application server needs to know how the users' home directories will be handled.
	  3 choices:
	</para>
        <itemizedlist>
          <listitem>
            <para>
              <emphasis role="strong">local</emphasis>: homes are present on the application server (our case); 
            </para>
          </listitem>
          <listitem>
            <para>
              <emphasis role="strong">nfs</emphasis>: an NFS server is used; 
            </para>
          </listitem>
          <listitem>
            <para>
              <emphasis role="strong">cifs</emphasis>: a CIFS server is used. 
            </para>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
	<para>
	  We pick 'local': 
	</para>
	<para>
	  <inlinemediaobject>
            <imageobject>
	      <imagedata fileref="img/filetype.png"/>
            </imageobject>
            <textobject>
	      <phrase>Debconf filesystem question</phrase>
	    </textobject>
	  </inlinemediaobject>
	</para>
      </listitem>
      <listitem>
	<para>
	  The application server also needs to know where are the home dirs. 
	  In our case it's <emphasis>/users</emphasis> (within the chroot).
	  If the directory doesn't exist, it is created during the first use of the service by the user.
	</para>
	<para>
	  <inlinemediaobject>
            <imageobject>
              <imagedata fileref="img/home.png"/>
            </imageobject>
            <textobject>
              <phrase>Debconf home base ask</phrase>
            </textobject>
	  </inlinemediaobject>
	</para>
      </listitem>
    </itemizedlist>

    <para>
      The configuration step is done. 
      The chroot will now be downloaded and unzipped, and the configuration options applied. 
      The application system you just download is maybe not up-to-date, so you have to update the system and restart the service:
    </para>
    <screen>
      <![CDATA[
# chroot /opt/connectme
# apt-get update
# apt-get dist-upgrade
# exit
# /etc/init.d/ulteo-od restart]]>
    </screen>
    <para>
      When update the <emphasis>connectme-daemon</emphasis>package, the <emphasis>/etc/connectme.conf</emphasis> could be overwrite. 
      It'll fix in futures version but ATM, if it apppear, you have to edit this file and change the configuration by hand. 
    </para>
  </section>
  
  <section>
    <title>Time to test</title>

    <section>
      <title>Communication between the Connectme and the Session Manager</title>
      <itemizedlist>
	<listitem>
          <para>
	    The 'ulteo-od' service is used to start services inside the chroot. To start or stop it use:
	  </para>
          <screen>
	    <![CDATA[
# /etc/init.d/ulteo-od stop
# /etc/init.d/ulteo-od start
# /etc/init.d/ulteo-od restart]]>
          </screen>
	</listitem>
      </itemizedlist>
      <para>
	You can know see http request on the session manager when ulteo-od is started on the application server (in apache log, <emphasis>/var/log/apache2/access.log</emphasis> by default).
	You can also check than sessions have correctly be registered:
      </para>
      <para>
	<inlinemediaobject>
          <imageobject>
            <imagedata fileref="img/sessionsreq.png"/>
          </imageobject>
          <textobject>
            <phrase>Apache access log</phrase>
          </textobject>
	</inlinemediaobject>
	
	<inlinemediaobject>
          <imageobject>
            <imagedata fileref="img/sessions.png"/>
          </imageobject>
          <textobject>
            <phrase>Session Manager spool directory</phrase>
          </textobject>
	</inlinemediaobject>
      </para>
    </section>

    <section>
      <title>Launch a Session</title>
      <para>
	Go back on <emphasis>http://fire.ulteo.com/sessionmanager/</emphasis>, the <emphasis>Server</emphasis> field is now populated with 'connectme.ulteo.com' followed by the number of available sessions. 
	Click on the green 'start' button to run a session:
      </para>
      <para>
        <inlinemediaobject>
          <imageobject>
	    <imagedata fileref="img/sessionstarter.png"/>
          </imageobject>
          <textobject>
	    <phrase>Session starter</phrase>
          </textobject>
        </inlinemediaobject>
      </para>
    </section>
  </section>

  <section>
    <title>Keep the system up-to-date</title>
    <para>
      We are working to improve and debug the system and packages so at the moment, there are many changes. 
      To be sure that you have the last version or a bug you noticed is fix, you have to be sure that your systems are up-to-date. 
    </para>
    <itemizedlist>
      <listitem>
	<para>
	  on the Session Manager:
	</para>
	<screen>
	  <![CDATA[
# apt-get update
# apt-get upgrade]]>
	</screen>
      </listitem>
      <listitem>
	<para>
	  on the Connectme Server:
	</para>
	<screen>
	  <![CDATA[
# apt-get update
# apt-get upgrade]]>
	</screen>
      </listitem>
      <listitem>
	<para>
	  you need also to update the application system (the chroot): 
	</para>
	<screen>
	  <![CDATA[
# chroot /opt/connectme
# apt-get update
# apt-get dist-upgrade]]>
	</screen>
      </listitem>
      <listitem>
	<para>
          finally, if the <emphasis>connectme-daemon</emphasis> has been updated,
	  you need to restart the service 
	</para>
	<screen>
	  <![CDATA[
# /etc/init.d/ulteo-od restart]]>
	</screen>
      </listitem>
    </itemizedlist>
  </section>

  <section>
    <title>Troubleshooting</title>


    <section>
      <title>No session when use a proxy</title>
      <para>
	Make sure that your proxy know the name of your server (DNS issue).
      </para>
    </section>
  </section>
  
  <section>
    <title>Where can i see the configuration or get informations about the system ?</title>
    <section>
      <title>Session manager</title>
      <itemizedlist>
	<listitem>
          <para>
            <emphasis role="strong">/etc/ulteo/sessionmanager/config.inc.php</emphasis>: 
          </para>
          <itemizedlist>
            <listitem>
              <para>
		<emphasis>$authorized_fqdn</emphasis>: array of authorized servers 
              </para>
            </listitem>
            <listitem>
              <para>
		<emphasis>$fqdn_private_address</emphasis>: hash table of name/ip pairs if needed: 
              </para>
              <screen>
<![CDATA[
$fqdn_private_address = array(
		'connectme.ulteo.com' => '192.168.1.3',
		);]]>
              </screen>
            </listitem>
            <listitem>
              <para>
		<emphasis>$default_locale</emphasis>: default language 
              </para>
            </listitem>
            <listitem>
              <para>
		<emphasis>$start_app</emphasis>: application started by default 
              </para>
            </listitem>
          </itemizedlist>
	</listitem>
	<listitem>
          <para>
            <emphasis role="strong">/var/log/ulteo/sessionmanager/sessionmanager.log</emphasis>: sessions log 
          </para>
	</listitem>
	<listitem>
          <para>
            <emphasis role="strong">/var/spool/ulteo/sessionmanager/</emphasis>: data used by the manager to know the sessions state (you shouldn't modify those files) 
          </para>
	</listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Application server</title>
      <itemizedlist>
	<listitem>
          <para>
	    <emphasis role="strong">/etc/connectme.conf</emphasis>: defines the chroot path 
          </para>
	</listitem>
	<listitem>
          <para>
            <emphasis role="strong">$CHROOT/etc/connectme.conf</emphasis>: 'connectmed' daemon configuration, responsible of starting/stopping/cleaning sessions (see the file for details on options) 
          </para>
	</listitem>
	<listitem>
          <para>
            <emphasis role="strong">$CHROOT/var/spool/connectme/sessions/</emphasis>: data used by the daemon
	    (don't modify this) 
          </para>
	</listitem>
      </itemizedlist>
      <para/>
      <section>
	<title>Log</title>
	<para>
          The log file is in <emphasis>$CHROOT/var/log/connectme.log</emphasis>.
	  There are different kind of informations in the log depends on which <emphasis>LOG_FLAGS</emphasis> you defined in your configuration.
          Available flags : 
	</para>
	<itemizedlist>
          <listitem>
            <para>
              <emphasis>error</emphasis>: an event that shouldn't appear, the system is probably going to quit 
	    </para>
          </listitem>
          <listitem>
            <para>
              <emphasis>warning</emphasis>: a serious problem was detected but should be solved 
            </para>
          </listitem>
          <listitem>
            <para>
              <emphasis>info</emphasis>: an information message 
            </para>
          </listitem>
          <listitem>
            <para>
              <emphasis>debug</emphasis>: a message to help developpers to find bugs 
            </para>
          </listitem>
	</itemizedlist>
	<para>
	  Some example messages : 
	</para>
	<itemizedlist>
          <listitem>
	    <para>
	      Create a session :
	    </para>
	    <screen>
	      <![CDATA[
[INFO] useradd SSH17 with uid : 5034
[INFO] groupadd -K GID_MAX=70000 VNC17
[INFO] useradd VNC17 with uid : 5035
[INFO] Session generating 17 => 2d4aebee0345a998fe68b6991ec35f18]]>
            </screen>
          </listitem>
          <listitem>
	    <para>
              Destroy a session :
	    </para>
            <screen>
	      <![CDATA[
[INFO] Killing Session b515124f650af852baeeabdd45be6644
[INFO] killall -u unfs2001
[INFO] kill_session 12
[INFO] userdel SSH12
[INFO] local:Local fs in /users
[INFO] userdel VNC12
[INFO] erasing previous b515124f650af852baeeabdd45be6644]]>
	    </screen>
          </listitem>
          <listitem>
	    <para>
              Declare a new available session on the session manager
	    </para>
            <screen>
	      <![CDATA[
[INFO] Request action=HELLO&amp;fqdn=ooo.ac-guadeloupe.fr&amp;session=21015e1fb41d6db43371c66e257cb8c5]]>
	    </screen>
          </listitem>
          <listitem>
            <para>when a user start his session </para>
            <screen>
	      <![CDATA[
[INFO] nickname: TweetyBird
[INFO] USER_HOME: /home/TweetyBird
[INFO] REMOTE_HOME: /home2/unfs2005
[INFO] local:Local fs in /users
[INFO] Prestart:Info: unknown.fileserver
xauth:  creating new authority file /tmpdir/tmp5023/.Xauthority
[INFO] LUCK does not exist, creating it
[INFO] startsession : session state 2
access control enabled, only authorized clients can connect]]>
            </screen>
          </listitem>
	</itemizedlist>
      </section>
    </section>
  </section>

  <section>
      <title>Install a new application on the application system</title>
    <para>
      In our exemple, we want install the mailer <emphasis>Thunderbird</emphasis>.
    </para>
    <para>
      At the moment, it's not possible to launch a session with any application available on the application ssystem. 
      So to use Thunderbird (or any application you install), you have to launch a fulle desktop session.
      So, you need to have an appliction ssytem that contain the kde desktop (chroot-douane's one).
    </para>

    <para>
      Commands need to be made on the connectme server.
    </para>

    <itemizedlist>
      <listitem>
	<para>
	  Install the package Thunderbird 
	</para>
	<screen>
	  <![CDATA[
# chroot /opt/connectme
# apt-get install thunderbird]]>
	</screen>
      </listitem>
      <listitem>
	<para>
	  Launch a full desktop session and :
	</para>
	<itemizedlist>
	  <listitem>
	    <para>right clic on the taskbar</para>
	  </listitem>
	  <listitem>
	    <para>Add Application to Panel</para>
	  </listitem>
	  <listitem>
	    <para>Internet</para>
	  </listitem>
	  <listitem>
	    <para>Mozilla Thunderbird Mail</para>
	  </listitem>
	</itemizedlist>
	
	<para>
	  <inlinemediaobject>
	    <imageobject>
              <imagedata fileref="img/install-thunderbird.png"/>
	    </imageobject>
	  </inlinemediaobject>
	</para>
      </listitem>
    </itemizedlist>

    <para>
      You now should launch Thunderbird by clic on his icon.
      Vous devriez maintenant pouvoir lancer Thunderbird en cliquant sur l'icône. Il sera bientôt possible de rendre tout cela automatique via une interface d'administration et de lancer une session avec seulement Thunderbird (pour suivre notre exemple).
    </para>
  </section>
</article>

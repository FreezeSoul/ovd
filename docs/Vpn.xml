<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN" 
"http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd">
<article>
  <articleinfo>
    <title>Ulteo Open Virtual Desktop</title>
    <subtitle>VPN solution</subtitle>
    <graphic fileref="img/ovd.png" align="center"/>

    <copyright>
      <year>2008</year>
      <year>2009</year>
      <year>2010</year>
      <holder>Ulteo SAS - <ulink url="http://www.ulteo.com" /></holder>
    </copyright>
  </articleinfo>

  <para>
    This document is aimed at providing a VPN solution that can 
    provide multi server access though Internet.
  </para>

  <para>
    This documentation can also be used to secure all the Ulteo data stream between
    the client software and Ulteo Open Virtual Desktop servers while that's not the primary goal.
  </para>

  <para>
    This documentation won't explain how to use authentication with
    the VPN client key. VPN is just used to make a virtual network to
    get access on multiple machines with only one IP public address.
  </para>

 <important>
    <para>
      The Linux commands started by
      a <emphasis role="strong">#</emphasis> must be done as
      root. Those started by a <emphasis role="strong">$</emphasis>
      can be done either by any user.
    </para>
  </important>

  <section>
    <title>Introduction</title>

    <para>
      Ulteo Open Virtual Desktop is a product that's using several
      server machines. Although for a demo or a small solution, it's possible
      to use a single machine for the whole OVD, on a production
      site, it's recommended to have several <emphasis>Application
      Servers</emphasis>.
    </para>

    <para>
      On a LAN it's not a problem to use several machines, because
      it's possible to use private IP addressing. But on Internet, it may be
      more difficult or too expensive to get several public IP addresses for only one
      service. 
    </para>

    <section>
        <title>Use Case</title>
        <para>
          A factory is installing OVD on their internal network. As a first
          step, employees have access to OVD when they are at
          work. On a second step, the factory wants to provide access to the Ulteo OVD from
          Internet so that employees can access their corporate
          desktop remotly (from home for instance).
        </para>

        <inlinemediaobject>
          <imageobject>
            <imagedata fileref="img/Vpn/main_view.png"/>
          </imageobject>
          <textobject>
            <phrase>...</phrase>
          </textobject>
        </inlinemediaobject>
      </section>

      <simpara>
        The issue is that the factory can only have one public IP address. So
        how to install the several Ulteo servers on only one address? The
        solution we are going to explain here is using the VPN technology.
      </simpara>

      <simplesect>
        <title>Networks:</title>
        
        <itemizedlist>
          <listitem>
            <para>
              <emphasis>Ulteo secure net:</emphasis>
              this network contains the Session Manager, all Application servers
              and the Ulteo VPN server.
            </para>
          </listitem>

          <listitem>
            <para>
              <emphasis>VPN:</emphasis>
              contains the Ulteo VPN server and all VPN client
            </para>
          </listitem>
          
          <listitem>
            <para>
              <emphasis>Factory network:</emphasis>
              the base network which is hosting all those servers
            </para>
          </listitem>
          
        </itemizedlist>
 
        <note>
          <para>
            The Ulteo secure net can be the factory network. It just
            depends on the security policy.
          </para>
        </note>
      </simplesect>

      <simplesect>
        <title>Routing</title>
        <para>
          The VPN server will provide a route to each client so that clients
          are able to reach the Ulteo secure network.
        </para>
        
        <para>
          IP address plan:
          <itemizedlist>
          <!--
            <listitem>
              <para>factory network: <emphasis>10.0.0.0/8</emphasis></para>
            </listitem>
          -->
            <listitem>
              <para>Ulteo secure network:
              <emphasis>10.0.1.0/24</emphasis></para>
            </listitem>
            <listitem>
              <para>VPN net: <emphasis>10.0.2.0/24</emphasis></para>
            </listitem>
          </itemizedlist>
    
          The VPN server will deliver a route to 10.0.2.0/24

          <inlinemediaobject>
            <imageobject>
              <imagedata fileref="img/Vpn/routing.png"/>
            </imageobject>
            <textobject>
              <phrase>...</phrase>
            </textobject>
          </inlinemediaobject>
        </para>
      </simplesect>

  </section>


<section>
  <title>VPN server installation</title>

  <important>
    <para>
      This documentation works for Debian lenny or Ubuntu Hardy
      systems. It may work on other systems too but we haven't tested it.
    </para>
  </important>

  <para>
    Install packages:
  </para>
  <screen>
    <![CDATA[
# apt-get install openvpn openssl zip]]>
  </screen>

    <section>
      <title>SSL keys generation</title>

      <itemizedlist>
        <listitem>
          <para>Create a working directory and place into it</para>
          <screen>
            <![CDATA[
$ cp -R /usr/share/doc/openvpn/examples/easy-rsa/2.0 ~/vpn-keys
$ cd ~/vpn-keys]]>
          </screen>
        </listitem>

        <listitem>
          <para>Config some environment variables into the file <emphasis
          role="strong">vars</emphasis></para>
          <screen>
            <![CDATA[
export KEY_COUNTRY="EN"
export KEY_PROVINCE="Your province"
export KEY_CITY="Your city"
export KEY_ORG="Ulteo"
export KEY_EMAIL="some@email.address"]]>
          </screen>
        </listitem>
        <listitem>
          <para>Load the following file and clean the directory</para>
          <screen>
            <![CDATA[ 
$ . ./vars
$ ./clean-all]]>
          </screen>
        </listitem>
        <listitem>
          <para>Build the certificate authority</para>
          <screen>
            <![CDATA[
$ ./build-ca]]>
          </screen>
        </listitem>
        <listitem>
          <para>Build the server key</para>
          <screen>
            <![CDATA[ 
$ ./build-key-server ulteo-vpn]]>
          </screen>
        </listitem>

        <listitem>
          <para>Build the Diffie-Hellman parameters</para>
          <screen>
            <![CDATA[
$ ./build-dh]]>
          </screen>
        </listitem>
      </itemizedlist>
<!--
      <note>
        <para>Be careful with server/client internal time when generating
        certificate! If server time is in the future the client
        certificate/key will not be valid until the server time is
        reached.
        </para>
      </note>
-->
    </section>

    <section>
      <title>OpenVPN configuration</title>

      <itemizedlist>
        <listitem>
          <para>Go into your key directory</para>
          <screen>
            <![CDATA[
$ cd ~/vpn-keys]]>
          </screen>
        </listitem>
        <listitem>
          <para>
            Copy the needed files to the openvpn directory
          </para>
          <screen>
            <![CDATA[
# cp ./keys/ca.crt              /etc/openvpn/
# cp ./keys/ulteo-vpn.crt       /etc/openvpn/
# cp ./keys/ulteo-vpn.key       /etc/openvpn/
# cp ./keys/dh1024.pem          /etc/openvpn/
# chmod 600 /etc/openvpn/ulteo-vpn.key]]>
          </screen>
        </listitem>
        <listitem>
          <para>
            Edit the <emphasis>/etc/openvpn/openvpn.conf</emphasis>
            file and paste the following text to it:
          </para>
          <screen>
            <![CDATA[
port 1194 ## You can use 443 if you 
          ## want to bypass some proxy/firewall
proto tcp
dev tun

ca ca.crt
cert ulteo-vpn.crt
key ulteo-vpn.key
dh dh1024.pem

server 10.0.2.0 255.255.255.0

push "route 10.0.1.0 255.255.255.0"
  # used to provide the route to the
  # Ulteo secure network

keepalive 10 120
persist-key
persist-tun
status openvpn-status.log]]>
          </screen>
        </listitem>
        <listitem>
          <para>Restart OpenVPN</para>
          <screen>
            <![CDATA[
# /etc/init.d/openvpn restart]]>
          </screen>
        </listitem>
      </itemizedlist>
    </section>
    <section>
      <title>Check the VPN status</title>
      <itemizedlist>
        <listitem>
          <para>Look at the tun0 network interface:</para>
          <screen>
            <![CDATA[
# ifconfig tun0]]>
          </screen>
          <para>
            You should get something like:
          </para>
          <screen>
            <![CDATA[
tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
          inet adr:10.0.2.1  P-t-P:10.0.2.2  Masque:255.255.255.255
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 lg file transmission:100
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)]]>
          </screen>
          <important>
            <para>
              If you don't have
              a <emphasis role="strong">tun0</emphasis> network
              interface, your VPN server is not working.
            </para>
          </important>
        </listitem>
      </itemizedlist>
    </section>
</section>


<section>
  <title>VPN client installation</title>

  <section>
    <title>SSL keys generation</title>
    <important>
      <para>
        These operations have to be performed on the Ulteo VPN server that you 
	used to build the server keys.
      </para>
    </important>

    <itemizedlist>
      <listitem>
        <para>Go to your key generation directory:</para>
        <screen>
          <![CDATA[
$ cd ~/vpn-keys]]>
        </screen>
      </listitem>
        <listitem>
          <para>Load the following file and clean the directory</para>
          <screen>
            <![CDATA[ 
$ . ./vars]]>
          </screen>
        </listitem>
        <listitem>
          <para>Build the client key</para>
          <screen>
            <![CDATA[
$ ./build-key client]]>
          </screen>
        </listitem>
        <listitem>
          <para>Create a ZIP file for client</para>
          <screen>
            <![CDATA[
$ cd keys
$ zip client.zip ca.crt client.key client.crt]]>
          </screen>
        </listitem>
    </itemizedlist>
  </section>

  <section>
    <title>OpenVPN configuration</title>

    <important>
      <para>
        These operations have to be done on the client machine you want to connect from.
      </para>
    </important>

    <section>
      <title>On <trademark>Windows</trademark></title>

      <itemizedlist>
        <listitem>
          <para>
            Get the OpenVPN <trademark>Windows</trademark> installer
            from <ulink url="http://www.openvpn.net/"/>
          </para>
        </listitem>
       <listitem>
          <para>
            Install openvpn without changing any option
          </para>
          <screenshot>
            <screeninfo>OpenVPN installer step 1</screeninfo>
            <graphic fileref="img/Vpn/install-step1.png"></graphic>
          </screenshot>

          <screenshot>
            <screeninfo>OpenVPN installer step 2</screeninfo>
            <graphic fileref="img/Vpn/install-step2.png"></graphic>
          </screenshot>
          <screenshot>
            <screeninfo>OpenVPN installer step 3</screeninfo>
            <graphic fileref="img/Vpn/install-step3.png"></graphic>
          </screenshot>
          <screenshot>
            <screeninfo>OpenVPN installer step 4</screeninfo>
            <graphic fileref="img/Vpn/install-step4.png"></graphic>
          </screenshot>          <screenshot>
            <screeninfo>OpenVPN installer step 5</screeninfo>
            <graphic fileref="img/Vpn/install-step5.png"></graphic>
          </screenshot>
          <screenshot>
            <screeninfo>OpenVPN installer step 6</screeninfo>
            <graphic fileref="img/Vpn/install-step6.png"></graphic>
          </screenshot>
        </listitem>
        <listitem>
          <para>
            Create a directory on your Desktop, copy the ZIP file
            from the server and extract the zip file to the same directory
          </para>
        </listitem>
        <listitem>
          <para>
            Create a new text file
            called <emphasis>client.ovpn</emphasis> and paste the following
            text inside:
          </para>
          <important>
            <para>
              Replace
              the <emphasis role="strong">vpn.ip.address</emphasis> by
              the current IP address of the VPN server you configured
              before.
            </para>
          </important>
          <screen>
            <![CDATA[
client
dev tun
proto tcp

remote vpn.ip.address 1194

resolv-retry infinite
nobind

persist-key
persist-tun

ca ca.crt
cert client.crt
key client.key]]>
          </screen>
        </listitem>
        <listitem>
          <para>
            Then right-click on the <emphasis>client.ovpn</emphasis> file and select <emphasis role="strong"></emphasis>
          </para>
          <screenshot>
            <screeninfo>start OpenVPN</screeninfo>
            <graphic fileref="img/Vpn/start.png"></graphic>
          </screenshot>
          <para>
            Then, you should see a window appearing looking like:
          </para>
          <screenshot>
            <screeninfo>started OpenVPN</screeninfo>
            <graphic fileref="img/Vpn/started.png"></graphic>
          </screenshot>

          <note>
            <para>
              The highlighted part shows that the connection succeeded.
            </para>
          </note>
        </listitem>
     </itemizedlist>

      <simplesect>
        <title>Check the VPN connection</title>
        <itemizedlist>
          <listitem>
            <para>
              Launch a Windows cmd and test to ping the VPN local IP
              address
            </para>
          <screenshot>
            <screeninfo>ping OpenVPN local address</screeninfo>
            <graphic fileref="img/Vpn/ping.png"></graphic>
          </screenshot>
          </listitem>
        </itemizedlist>
      </simplesect>

    </section>
  
    <section>
      <title>On Linux</title>

      <itemizedlist>
        <listitem>
          <para>
            Install OpenVPN and unzip software.
          </para>
          <para>
            If you are using a Debian based system:
          </para>
          <screen>
            <![CDATA[
# apt-get install openvpn openssl zip]]>
          </screen>
        </listitem>
        <listitem>
          <para>
            Get the ZIP file from the server and copy it
            to <emphasis>/etc/openvpn/</emphasis>
          </para>
        </listitem>
       <listitem>
          <para>
            Extract the zip file
            to <emphasis>/etc/openvpn/</emphasis>
          </para>
          <screen>
            <![CDATA[
# cd /etc/openvpn/
# unzip client.zip
# chmod 600 client.key]]>
          </screen>
        </listitem>
<!--
        <listitem>
          <para>
            Copy the files from the removable device to the OpenVPN
            directory
          </para>
          <screen>
            <![CDATA[
# cp /media/disk/ca.crt      /etc/openvpn/
# cp /media/disk/client.crt  /etc/openvpn/
# cp /media/disk/client.key  /etc/openvpn/
# chmod 600 /etc/openvpn/client.key]]>
          </screen>
        </listitem>
-->
        <listitem>
          <para>
            Edit the <emphasis>/etc/openvpn/openvpn.conf</emphasis>
            file and copy paste the following text inside:
          </para>
          <important>
            <para>
              Replace
              the <emphasis role="strong">vpn.ip.address</emphasis> by
              the effective IP address of the VPN server you configured
              before.
            </para>
          </important>
          <screen>
            <![CDATA[
client
dev tun
proto tcp

remote vpn.ip.address 1194

resolv-retry infinite
nobind

persist-key
persist-tun

ca ca.crt
cert client.crt
key client.key]]>
          </screen>
        </listitem>
        <listitem>
          <para>Restart OpenVPN</para>
          <screen>
            <![CDATA[
# /etc/init.d/openvpn restart]]>
          </screen>
        </listitem>
      </itemizedlist>

      <simplesect>
        <title>Check the VPN connection</title>
        <itemizedlist>
          <listitem>
            <para>Look at the tun0 network interface</para>
            <screen>
              <![CDATA[
# ifconfig tun0]]>
            </screen>
            <para>
              You should get something like:
            </para>
            <screen>
              <![CDATA[
tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
          inet adr:10.0.2.6  P-t-P:10.0.2.5  Masque:255.255.255.255
          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
          Packets reçus:0 erreurs:0 :0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 lg file transmission:100
          Octets reçus:0 (0.0 B) Octets transmis:0 (0.0 B)]]>
            </screen>
            <important>
              <para>
                If you don't have
                a <emphasis role="strong">tun0</emphasis> network
                interface your VPN client is not working.
              </para>
            </important>
          </listitem>
          <listitem>
            <para>Ping the VPN server with the local IP address</para>
            <screen>
              <![CDATA[
$ ping 10.0.2.1
PING 10.0.2.1 (10.0.2.1) 56(84) bytes of data.
64 bytes from 10.0.2.1: icmp_seq=1 ttl=64 time=0.711 ms
64 bytes from 10.0.2.1: icmp_seq=2 ttl=64 time=0.668 ms
...
]]>
            </screen>
          </listitem>
        </itemizedlist>
      </simplesect>
    </section>
  </section>
</section>

<section>
  <title>Routing configuration</title>
  <section>
      <title>Set the VPN server as a router</title>
      <important>
        <para>Those operations have to be done on the VPN server.</para>
      </important>
      <itemizedlist>
        <listitem>
          <para>Enable IP forwarding as default at system boot</para>
          <para>
            Open <emphasis>/etc/sysctl.conf</emphasis> and uncomment
            the following line:
          </para>
          <screen>
            <![CDATA[
net.ipv4.ip_forward=1]]>
          </screen>
        </listitem>
        <listitem>
          <para>Enable IP forwarding for the current system</para>
          <screen>
            <![CDATA[
# echo 1 > /proc/sys/net/ipv4/ip_forward]]>
          </screen>
        </listitem>
      </itemizedlist>
    </section>

  <section>
    <title>Set the route on other network machines</title>
    <para>
      All other servers on the network (Session Manager, ApS,
      ...) have to be able to route
      to <emphasis>10.0.2.0/24</emphasis>.
    </para>
    <para>
      Either the DHCP server can provide the route or you can define it by
      hand:
    </para>
    <screen>
      <![CDATA[
# route add -net 10.0.2.0/24 gw 10.0.1.100]]>
    </screen>
  </section>
  <section>
    <title>Tests</title>
    <para>On client machine ping the Session Manager</para>
    <screen>
      <![CDATA[
$ ping 10.0.1.20
PING 10.0.1.20 (10.0.1.20) 56(84) bytes of data.
64 bytes from 10.0.1.20: icmp_seq=1 ttl=64 time=0.711 ms
64 bytes from 10.0.1.20: icmp_seq=2 ttl=64 time=0.668 ms
...]]>
     </screen>
  </section>
</section>


<section>
  <title>Test a session</title>

  <para>
    Open a browser with the Session manager local
    address: <emphasis role="strong">10.0.1.20</emphasis> and start a
    session.
  </para>

  <screenshot>
    <screeninfo>Login on SM</screeninfo>
    <graphic fileref="img/Vpn/sm_login.png"></graphic>
  </screenshot>

  <screenshot>
    <screeninfo>Login on SM</screeninfo>
    <graphic fileref="img/Vpn/aps_session.png"></graphic>
  </screenshot>
</section>

</article>
